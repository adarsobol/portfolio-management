#!/usr/bin/env node
/**
 * Setup script to extract Google Service Account credentials from JSON key file
 * and create/update .env file
 */

const fs = require('fs');
const path = require('path');

const SPREADSHEET_ID = '1mN4c67FfOzsp7KBrsivKrS1NFwTk_x75AQwkYenhIQM';
const SERVICE_ACCOUNT_EMAIL = 'sheets-sync@research-modeling-vertex-ai.iam.gserviceaccount.com';

// Try to find the JSON key file
const possiblePaths = [
  path.join(process.cwd(), 'research-modeling-vertex-ai-4a2e063ae2b5.json'),
  path.join(process.env.HOME, 'Downloads', 'research-modeling-vertex-ai-4a2e063ae2b5.json'),
  path.join(process.env.HOME, 'Downloads', '*.json'),
];

let keyFilePath = null;
let keyData = null;

// Try to find and read the key file
for (const possiblePath of possiblePaths) {
  try {
    if (fs.existsSync(possiblePath)) {
      keyFilePath = possiblePath;
      keyData = JSON.parse(fs.readFileSync(possiblePath, 'utf8'));
      console.log(`‚úÖ Found key file: ${keyFilePath}`);
      break;
    }
  } catch (e) {
    // Continue searching
  }
}

if (!keyData) {
  console.log('\n‚ö†Ô∏è  Could not find the service account JSON key file.');
  console.log('Please download it from Google Cloud Console and place it in the project root.');
  console.log('Expected filename: research-modeling-vertex-ai-4a2e063ae2b5.json\n');
  process.exit(1);
}

// Extract credentials
const privateKey = keyData.private_key;

if (!privateKey) {
  console.error('‚ùå Invalid key file: missing private_key');
  process.exit(1);
}

// Create .env file content
const envContent = `# Google Sheets Integration Configuration
# Generated by setup-sheets-env.js

# Spreadsheet ID (from URL: https://docs.google.com/spreadsheets/d/{ID}/edit)
GOOGLE_SPREADSHEET_ID=${SPREADSHEET_ID}

# Service Account Email
GOOGLE_SERVICE_ACCOUNT_EMAIL=${SERVICE_ACCOUNT_EMAIL}

# Service Account Private Key (from JSON key file)
# Note: The key contains newlines, so it's stored as a single-line string with \\n
GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=${privateKey.replace(/\n/g, '\\n')}
`;

// Write .env file
const envPath = path.join(process.cwd(), '.env');
fs.writeFileSync(envPath, envContent, 'utf8');

console.log('\n‚úÖ Successfully created .env file!');
console.log(`\nüìã Configuration:`);
console.log(`   Spreadsheet ID: ${SPREADSHEET_ID}`);
console.log(`   Service Account: ${SERVICE_ACCOUNT_EMAIL}`);
console.log(`   Key file: ${keyFilePath}`);
console.log(`\nüöÄ You can now start the server with: npm run server\n`);

